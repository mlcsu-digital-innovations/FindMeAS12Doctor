<!-- standard navbar -->
<app-navbar></app-navbar>
<div class="page-content">
  <div class="card" style="width: 100%;">
    <div class="card-body">
      <h5 class="card-title">Create New Referral</h5>
      <h6 class="card-subtitle mb-2 text-muted">
        Create a new referral and patient (if required)
      </h6>

      <form [formGroup]="patientForm" novalidate>
        <div class="form-row">
          <div class="col-md-2 offset-md-2 mb-2">
            <label for="nhsNumber">NHS Number</label>
            <input
              type="text"
              digitOnly
              maxlength="10"
              formControlName="nhsNumber"
              id="nhsNumber"
              class="form-control"
              [ngClass]="{
                'is-invalid': HasInvalidNHSNumber(),
                'is-valid': HasValidNHSNumber()
              }"
            />
          </div>
          <div class="col-md-1 mb-1">
            <div class="column-div">
              <span>Or</span>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <label for="alternativeIdentifier">Alternative Identifier</label>
            <input
              type="text"
              maxlength="200"
              formControlName="alternativeIdentifier"
              [appDisableControl]="DisableIfFieldHasValue('nhsNumber')"
              class="form-control"
              [ngClass]="{
                'is-invalid': HasInvalidAlternativeIdentifier(),
                'is-valid': HasValidAlternativeIdentifier()
              }"
            />
          </div>
          <div class="col-md-2 mb-2">
            <div class="column-div">
              <button
                type="button"
                class="btn btn-primary"
                placement="right"
                ngbTooltip="Search for existing patients using these identifiers"
                [openDelay]="1000"
                [closeDelay]="500"
                tooltipClass="subtle-tooltip"
                [disabled]="
                  DisablePatientValidationButtonIfFieldsAreInvalid() ||
                  IsSearchingForPatient()
                "
                (click)="ValidatePatient()"
                [ngClass]="{ validating: IsSearchingForPatient() }"
              >
                {{ IsSearchingForPatient() ? "Validating" : "Validate" }}
                <span
                  class="spinner-border spinner-border-sm"
                  role="status"
                  aria-hidden="true"
                  *ngIf="IsSearchingForPatient()"
                ></span>
              </button>
            </div>
          </div>
        </div>
        <!-- Row for divs showing patient number validation errors -->
        <div class="form-row">
          <div class="col-md-2 mb-2  offset-md-2 reduced-top-margin">
            <div *ngIf="patient.nhsNumber.errors" class="invalid-field">
              <span>Invalid NHS Number</span>
            </div>
          </div>
          <div class="col-md-2 mb-2 offset-md-1 reduced-top-margin">
            <div
              *ngIf="patient.alternativeIdentifier.errors"
              class="invalid-field"
            >
              <span>Invalid Alternative Identifier</span>
            </div>
          </div>
        </div>
        <!-- GP Practice -->
        <div class="form-row" *ngIf="gpFieldsShown">
          <div class="col-md-6  offset-md-2 mb-6">
            <label for="gpPractice">GP Practice {{gpSearchFailed}}</label>
            <input
              type="text"
              class="form-control"
              id="gpPractice"
              #gpPractice
              [appDisableControl]="!IsPatientIdValidated()"
              [class.is-invalid]="gpSearchFailed"
              formControlName="gpPractice"
              [ngbTypeahead]="gpSearch"
              [resultFormatter]="FormatTypeAheadResults"
              [inputFormatter]="FormatTypeAheadResults"
            />
          </div>
          <div class="col-md-2 mb-2">
            <div class="checkmark-content">
              <label class="container">
                <input
                  class="form-control"
                  type="checkbox"
                  value=""

                  id="unknownGpPractice"
                  formControlName="unknownGpPractice"
                  (change)="ToggleGpPracticeUnknown($event)"
                />
                <span class="checkmark"></span>
                Unknown
              </label>
            </div>
          </div>
        </div>
        <!-- GP Practice Errors-->
        <div class="form-row" *ngIf="gpFieldsShown">
          <div class="col-md-4 offset-md-2 mb-4">
            <span *ngIf="gpSearching">searching...</span>
            <div class="invalid-field" *ngIf="gpSearchFailed">
              Sorry, suggestions could not be loaded.
            </div>
          </div>
        </div>
        <!-- Residential Postcode -->
        <div class="form-row" *ngIf="residentialPostcodeFieldShown">
          <div class="col-md-2 offset-md-2 mb-2">
            <label for="residentialPostcode">Residential Postcode</label>
            <input
              type="text"
              maxlength="8"
              minlength="6"
              formControlName="residentialPostcode"
              #residentialPostcode
              [appDisableControl]="!IsPatientIdValidated()"
              id="residentialPostcode"
              oninput="this.value = this.value.toUpperCase()"
              class="form-control"
              [ngClass]="{
                'is-invalid': HasInvalidPostcode(),
                'is-valid': HasValidPostcode()
              }"
            />
          </div>
          <div class="col-md-1 mb-1">
            <div class="checkmark-content less-space">
              <label class="container">
                <input
                  class="form-control"
                  type="checkbox"
                  [appDisableControl]="!IsPatientIdValidated()"
                  value=""
                  id="unknownResidentialPostcode"
                  formControlName="unknownResidentialPostcode"
                  (change)="ToggleResidentialPostcodeUnknown($event)"
                />
                <span class="checkmark"></span>
                Unknown
              </label>
            </div>
          </div>
          <div class="col-md-2 mb-2">
            <div class="column-div">
              <button
                type="button"
                class="btn btn-primary less-padding"
                placement="right"
                ngbTooltip="Check that postcode is valid"
                [openDelay]="1000"
                [closeDelay]="500"
                tooltipClass="subtle-tooltip"
                [disabled]="
                  DisablePostcodeValidationButtonIfFieldIsInvalid() ||
                  IsSearchingForPostcode() ||
                  !IsPatientIdValidated()
                "
                (click)="ValidatePostcode()"
                [ngClass]="{ validating: IsSearchingForPostcode() }"
              >
                {{ IsSearchingForPostcode() ? "Validating" : "Validate" }}
                <span
                  class="spinner-border spinner-border-sm"
                  role="status"
                  aria-hidden="true"
                  *ngIf="IsSearchingForPostcode()"
                ></span>
              </button>
            </div>
          </div>
        </div>
        <!-- Residential Postcode Errors-->
        <div class="form-row" *ngIf="residentialPostcodeFieldShown">
          <div class="col-md-2 mb-2  offset-md-2 reduced-top-margin">
            <div
              *ngIf="patient.residentialPostcode.errors"
              class="invalid-field"
            >
              <span>{{ residentialPostcodeValidationMessage }}</span>
            </div>
          </div>
        </div>
        <!-- CCG -->
        <div class="form-row" *ngIf="ccgFieldsShown">
          <div class="col-md-6 offset-md-2 mb-6">
            <label for="ccg">Clinical Commissioning Group</label>
            <input
              type="text"
              class="form-control"
              id="ccg"
              #ccg
              [appDisableControl]="!IsPatientIdValidated()"
              [class.is-invalid]="ccgSearchFailed"
              formControlName="ccg"
              [ngbTypeahead]="ccgSearch"
              [resultFormatter]="FormatTypeAheadResults"
              [inputFormatter]="FormatTypeAheadResults"
            />
          </div>
          <div class="col-md-2 mb-2">
            <div class="checkmark-content">
              <label class="container">
                <input
                  class="form-control"
                  type="checkbox"
                  [appDisableControl]="!IsPatientIdValidated()"
                  value=""
                  id="unknownCcg"
                  formControlName="unknownCcg"
                  (change)="ToggleCcgUnknown($event)"
                />
                <span class="checkmark"></span>
                Unknown
              </label>
            </div>
          </div>
        </div>
        <!-- CCG Errors-->
        <div class="form-row" *ngIf="ccgFieldsShown">
          <div class="col-md-4 mb-4 offset-md-2">
            <span *ngIf="ccgSearching">searching...</span>
            <div class="invalid-field" *ngIf="ccgSearchFailed">
              Sorry, suggestions could not be loaded.
            </div>
          </div>
        </div>
        <!-- AMHP User -->
        <div class="form-row">
          <div class="col-md-6  offset-md-2 mb-6">
            <label for="amhp">Lead AMHP</label>
            <input
              type="text"
              class="form-control"
              id="amhp"
              #amhp
              [appDisableControl]="!IsPatientIdValidated()"
              [class.is-invalid]="amhpSearchFailed"
              formControlName="amhp"
              [ngbTypeahead]="amhpSearch"
              [resultFormatter]="FormatTypeAheadResults"
              [inputFormatter]="FormatTypeAheadResults"
            />
          </div>
        </div>
        <!-- AMHP User Errors-->
        <div class="form-row">
          <div class="col-md-4 offset-md-2 mb-4">
            <span *ngIf="amhpSearching">searching...</span>
            <div class="invalid-field" *ngIf="amhpSearchFailed">
              Sorry, suggestions could not be loaded.
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="col-md-2 mb-2">
            <span>-</span>
          </div>
        </div>
        <div class="form-row">
          <div class="col-md-1 mb-1 offset-md-6">
            <button class="btn btn-primary standard-button" type="button" (click)="CancelReferral()">Cancel</button>
          </div>
          <div class="col-md-1 mb-1 centered">
            <button class="btn btn-primary standard-button" type="button" (click)="CreateReferral()" [disabled]="!HasValidReferral()">Save</button>
          </div>
        </div>
      </form>

      <div class="overlay" *ngIf="creatingReferral">
        <div class="spinner-div spinner-border">
          <span class="spinner"></span>
        </div>
      </div>

      <!-- format of danger toast -->
      <ng-template #dangerTpl>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="#fff"
          width="24"
          height="24"
          viewBox="0 0 24 24"
        >
          <path
            d="M10.872 6.831l1.695 3.904 3.654-1.561-1.79 3.426 3.333.954-3.417 1.338 2.231 4.196-4.773-2.582-2.869 2.287.413-3.004-3.792-.726 2.93-1.74-1.885-2.512 3.427.646.843-4.626zm-.786-6.831l-1.665 9.119-6.512-1.228 3.639 4.851-5.548 3.294 7.108 1.361-.834 6.076 5.742-4.577 9.438 5.104-4.288-8.064 6.834-2.677-6.661-1.907 3.25-6.22-6.98 2.982-3.523-8.114z"
          />
        </svg>
        {{ dangerMessage }}
      </ng-template>

      <!-- patient results, used in modal -->
      <ng-template #patientResults>
        <div class="modal-header">
          <h4 class="modal-title">Existing Patient Found</h4>
        </div>
        <div class="modal-body">
          <div
            class="row current-referral"
            *ngIf="patientResult.currentReferralId !== null"
          >
            <div class="col-md-12">
              <span>
                ! An active referral exists for this patient !
              </span>
            </div>
          </div>
          <div class="row" *ngIf="patientResult.nhsNumber !== null">
            <div class="col-md-4 row-title">
              NHS Number
            </div>
            <div class="col-md-8 row-value">
              {{ patientResult.nhsNumber }}
            </div>
          </div>
          <div class="row" *ngIf="patientResult.alternativeIdentifier !== null">
            <div class="col-md-4 row-title">
              Alternative Identifier
            </div>
            <div class="col-md-8 row-value">
              {{ patientResult.alternativeIdentifier }}
            </div>
          </div>
          <div
            class="row"
            *ngIf="patientResult.gpPracticeNameAndPostcode !== null"
          >
            <div class="col-md-4 row-title">
              GP Practice
            </div>
            <div class="col-md-8 row-value">
              {{ patientResult.gpPracticeNameAndPostcode }}
            </div>
          </div>
          <div class="row" *ngIf="patientResult.residentialPostcode !== null">
            <div class="col-md-4 row-title">
              Patients Residential Postcode
            </div>
            <div class="col-md-8 row-value">
              {{ patientResult.residentialPostcode }}
            </div>
          </div>
          <div class="row" *ngIf="patientResult.ccgName !== null">
            <div class="col-md-4 row-title">
              CCG
            </div>
            <div class="col-md-8 row-value">
              {{ patientResult.ccgName }}
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-primary"
            (click)="CancelPatientResultsModal()"
          >
            Cancel
          </button>
          <button
            type="button"
            class="btn btn-primary"
            (click)="UseExistingPatient()"
            *ngIf="patientResult.currentReferralId == null"
          >
            Use Existing Details
          </button>
          <button
            type="button"
            class="btn btn-primary"
            (click)="UseExistingReferral()"
            *ngIf="patientResult.currentReferralId !== null"
          >
            Use Existing Referral
          </button>
        </div>
      </ng-template>

      <ng-template #cancelReferral>
        <div class="modal-header">
          <h4 class="modal-title">Cancel Referral ?</h4>
        </div>
        <div class="modal-body">
          <h5>Please confirm that you wish to cancel this referral creation. All changes will be lost.</h5>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" (click)="CancelCancellation()">Cancel</button>
          <button type="button" class="btn btn-primary" (click)="ConfirmCancellation()">Confirm</button>
        </div>
      </ng-template>

      <app-toasts aria-live="polite" aria-atomic="true"></app-toasts>

      <!-- <a href="#" class="card-link">Cancel (does nothing)</a>
      <a href="#" class="card-link">Save (does nothing)</a> -->
    </div>
  </div>
</div>
